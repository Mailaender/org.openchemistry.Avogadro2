app-id: org.openchemistry.Avogadro2
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
command: avogadro2
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
cleanup:
  #- /bin/papraview
  #- /include
  #- /lib/cmake
  #- /share/doc
  #- /share/applications
  #- /share/castxml
  #- *.la
  #- *.a

modules:
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.json
  
  - name: python3-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - pip3 install --prefix=/app .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/d2/48/f445be426ccd9b2fb64155ac6730c7212358882e589cd3717477d739d9ff/numpy-1.20.1.zip
        sha256: 3bc63486a870294683980d76ec1e3efc786295ae00128f9ea38e2c6e74d5a60a
        
  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.bz2
        sha256: 0fa5cafe78f66d2b501b43016858070d52ba47bd9b1016b0165a7b8e04675677
    cleanup: 
      - "*"
      
  - name: libxml2
    sources:
      - type: archive
        url: http://xmlsoft.org/sources/libxml2-2.9.0.tar.gz
        sha256: ad25d91958b7212abdc12b9611cfb4dc4e5cddb6d1e9891532f48aacee422b82  
      
  - name: libarchive
    sources:
      - type: archive
        url: https://www.libarchive.de/downloads/libarchive-3.5.1.zip
        sha256: 8258794a3ec607dc1693aadda68e23c3521639e477973eb37901f238c7534bfc
  
  - name: hdf5
    sources:
      - type: archive
        url: https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.12/hdf5-1.12.0/src/hdf5-1.12.0.tar.gz
        sha256: a62dcb276658cb78e6795dd29bf926ed7a9bc4edf6e77025cd2c689a8f97c17a
    cleanup:
      - "/share/hdf5_examples"
  
  - name: libmsym
    buildsystem: cmake
    config-opts:
      - -DMSYM_BUILD_PYTHON:BOOL=ON
      - -DBUILD_SHARED_LIBS:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/mcodev31/libmsym/archive/refs/tags/v0.2.3-paper.tar.gz
        sha256: 3741ebe163cf40696570d6b62e4834ca587d43dcac9de713994cc5e2960fb8fd
    #cleanup:
      #- /lib/cmake
      
  - name: pybind11    
    buildsystem: simple
    build-commands:
      - python3.8 setup.py build
      - cmake -DPYBIND11_INSTALL=ON -DPYBIND11_TEST=OFF -DCMAKE_INSTALL_INCLUDEDIR:PATH=/app/include -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib -DCMAKE_INSTALL_DATAROOTDIR:PATH=/app/share .
      - python3.8 setup.py install --prefix=/app
      - cmake --build .
      - cmake --install .
    sources:
      - type: archive
        url: https://github.com/pybind/pybind11/archive/v2.6.2.tar.gz
        sha256: 8ff2fff22df038f5cd02cea8af56622bc67f5b64534f1b83b9f133b8366acff2
      
  - name: mmtf-cpp
    buildsystem: cmake
    config-opts:
      - -DBUILD_TESTS:BOOL=OFF
      - -Dmmtf_build_local:BOOL=ON
      - -Dmmtf_build_examples:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/rcsb/mmtf-cpp/archive/refs/tags/v1.0.0.tar.gz
        sha256: 881f69c4bb56605fa63fd5ca50842facc4947f686cbf678ad04930674d714f40
        
  - name: msgpack
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX:PATH=/app
      - -DBUILD_SHARED_LIBS:BOOL=ON
      - -DMSGPACK_ENABLE_STATIC:BOOL=OFF
      - -DCMAKE_INSTALL_LIBDIR:PATH=lib
      - -DMSGPACK_BUILD_EXAMPLES:BOOL=OFF
      - -DMSGPACK_CXX11:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/msgpack/msgpack-c/releases/download/cpp-3.3.0/msgpack-3.3.0.tar.gz
        sha256: 6e114d12a5ddb8cb11f669f83f32246e484a8addd0ce93f274996f1941c1f07b

  - name: OpenBabel
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DCMAKE_INSTALL_PREFIX:PATH=/app
      - -DLIB_INSTALL_DIR:PATH=/app/lib
      - -DMINIMAL_BUILD:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/openbabel/openbabel/releases/download/openbabel-3-1-1/openbabel-3.1.1-source.tar.bz2
        sha256: a6ec8381d59ea32a4b241c8b1fbd799acb52be94ab64cdbd72506fb4e2270e68

  - name: zeromq
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    #cleanup:
      #- /bin
    sources:
      - type: archive
        url: https://github.com/zeromq/libzmq/releases/download/v4.3.3/zeromq-4.3.3.tar.gz
        sha256: 9d9285db37ae942ed0780c016da87060497877af45094ff9e1a1ca736e3875a2        
        
  - name: MoleQueue
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DENABLE_TESTING:BOOL=OFF
      - -DBUILD_DOCUMENTATION:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/OpenChemistry/molequeue/releases/download/0.9.0/molequeue-0.9.0.tar.bz2
        sha256: 2825fa9645fca707796ad32967c307bec76dab4f6c305befeebeac8c7f7f2ef0
        
  - name: protobuf
    buildsystem: cmake
    subdir: cmake
    sources:
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v3.15.6/protobuf-cpp-3.15.6.tar.gz
        sha256: bbdfb7455431d7d58666e8a2996d14b236718ff238eecde10646581e4c87f168
        
  - name: protocall-OpenChemistry 
    buildsystem: cmake
    sources:
      - type: git
        url: https://github.com/OpenChemistry/protocall
        
  - name: VTK
    buildsystem: cmake
    builddir: true
    config-opts:
    #- -DVTK_BUILD_ALL_MODULES=OFF 
    - -DBUILD_SHARED_LIBS=ON
    - -DOpenGL_GL_PREFERENCE=GLVND
    #- -DVTK_USE_TK=OFF
    #- -DVTK_WRAP_JAVA=OFF
    #- -DVTK_WRAP_PYTHON=ON
    - -DCMAKE_BUILD_TYPE=Release
    - -DVTK_PYTHON_VERSION:STRING=3
    - -DVTK_GROUP_ENABLE_Qt=YES
    - -DVTK_MODULE_ENABLE_VTK_GUISupportQt=YES
    - -DModule_vtkGUISupportQtOpenGL:BOOL=ON
    #cleanup:
      #- /bin
    sources:
      - type: archive
        url: https://github.com/Kitware/VTK/archive/refs/tags/v8.2.0.tar.gz
        sha256: 96acfe0b4304218561bf2a88ca23aa35df51293d7ed9c3232c1d05a2012f405b
        
  - name: spglib
    buildsystem: simple
    build-commands:
      # Delete easy-install.pth that spglib previously install because pybind11 clash with it.
      - rm -r /app/lib/python3.8/site-packages/easy-install.pth
      - cmake -DCMAKE_INSTALL_INCLUDEDIR:PATH=/app/local -DCMAKE_INSTALL_LIBDIR:PATH=/app/local .
      - cmake --build .
      - cmake --install .
      - cd python && python3.8 setup.py build
      - cd python && python3.8 setup.py install --skip-build --force --prefix=/app
    sources:
      - type: archive
        url: https://github.com/spglib/spglib/archive/refs/tags/v1.16.1.tar.gz
        sha256: e90682239e4ef63b492fa4e44f7dbcde2e2fe2e688579d96b01f2730dfdf5b2e
        
  #- name: Avogadro2-superbuild-method
    #buildsystem: simple
    #build-commands:
      #- mkdir -p build/thirdparty/download
      #- cd build && cmake -DCMAKE_BUILD_TYPE:STRING=Release -DUSE_HDF5=ON -DUSE_PYTHON=ON -Ddownload_dir:PATH=/download ..
      #- touch build/thirdparty/libarchive-prefix/src/libarchive-stamp/libarchive-download build/thirdparty/libarchive-prefix/src/libarchive-stamp/libarchive-mkdir
      ##- touch build/thirdparty/libarchive-prefix/src/libarchive-stamp/libarchive-download build/thirdparty/libarchive-prefix/src/libarchive-stamp/libarchive-update build/thirdparty/libarchive-prefix/src/libarchive-stamp/libarchive-patch build/thirdparty/libarchive-prefix/src/libarchive-stamp/libarchive-mkdir
      #- cd build && cmake --build . --config Release
    ##builddir: true
    ##config-opts:
      ##- -DCMAKE_BUILD_TYPE:STRING=Release
      ##- -DUSE_HDF5=ON
      ##- -DUSE_PYTHON=ON
      ##- -Ddownload_dir=
    #sources:
      #- type: git
        #url: https://github.com/OpenChemistry/openchemistry
        #tag: 1.93.0
        #commit: caa10896317bce3e970e1490a9a075c640a6b80e
      #- type: file
        #url: https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.gz
        #md5: 609286804b0f79be622ccf7f9ff2b660
        #dest: build/thirdparty/download
      #- type: file
        #url: https://github.com/atztogo/spglib/archive/v1.10.4.tar.gz
        #md5: df49ddccecfe82e50ade640d6547571b
        #dest: build/thirdparty/download
      #- type: file
        #url: https://github.com/libarchive/libarchive/archive/v3.3.2.tar.gz
        #md5: a3acebe237f89d7f31c5bb1da5e843c7
        #dest: build/thirdparty/download
        
  - name: avogadrolibs
    buildsystem: cmake
    #builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE:STRING=Release
      - -DCMAKE_INSTALL_DATAROOTDIR:PATH=/app/share
      - -DCMAKE_INSTALL_BIRDIR:PATH=/app/bin
      - -DCMAKE_INSTALL_INCLUDEDIR:PATH=/app/include
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
      - -DCMAKE_INSTALL_PREFIX:PATH=/app
      - -DENABLE_TRANSLATIONS:BOOL=ON
      - -DUSE_HDF5:BOOL=ON
      - -DUSE_PYTHON:BOOL=ON
      - -DUSE_QT:BOOL=ON
      - -DUSE_LIBMSYM:BOOL=ON
      - -DUSE_SPGLIB:BOOL=ON
      - -DUSE_MMTF:BOOL=ON
      - -DUSE_MOLEQUEUE:BOOL=ON
      - -DUSE_PROTOCALL:BOOL=OFF
      - -DUSE_VTK:BOOL=OFF
      - -DBUILD_GPL_PLUGINS:BOOL=ON
      - -DBUILD_STATIC_PLUGINS:BOOL=ON
      - -Dlibmsym_DIR:PATH=/app/lib/cmake/libmsym
      - -DSPGLIB_INCLUDE_DIR:PATH=/app/include
      - -DSPGLIB_LIBRARY:PATH=/app/lib
      - -Dpybind11_DIR:PATH=/app/lib/python3.8/site-packages/pybind11-2.6.2-py3.8.egg/pybind11/share/cmake/pybind11/
    sources:
      - type: git
        url: https://github.com/OpenChemistry/avogadrolibs
        #tag: 1.93.1
        commit: 9123e3837ab0d819677ec8e2ed3c46875054382f
        #4f1b21de000046c04a39829063c6416fbd70922b
        
  - name: Avogadro2
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DENABLE_RPATH:BOOL=ON
      - -DENABLE_TESTING:BOOL=OFF
      - -DAvogadroLibs_DIR:PATH=/app/lib
      - -DBUILD_DOCUMENTATION:BOOL=ON
      - -DCMAKE_BUILD_TYPE:STRING=Release
    sources:
      - type: git
        url: https://github.com/OpenChemistry/avogadroapp
        tag: 1.93.0
        commit: 59c4dbd09821440df02b71fb963c4bae8e0fb6d0
